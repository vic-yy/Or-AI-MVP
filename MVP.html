<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OrçaAI – Analisador de Despesas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap">
<style>
body{font-family:"Inter",sans-serif;background:#f3f4f6}
.drawer-enter{animation:slide .25s forwards}
@keyframes slide{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
</style>
</head>
<body class="text-gray-800">

<!-- ===================== 1) UPLOAD ===================== -->
<section id="uploadView" class="min-h-screen flex flex-col items-center justify-center p-8">
<div class="bg-white w-full max-w-md p-10 rounded-2xl text-center shadow-xl">
  <h1 class="text-4xl font-extrabold text-blue-600 mb-6">OrçaAI</h1>
  <p class="text-gray-600 mb-6">
    Faça upload do seu extrato (<code>.csv</code>) e receba insights.<br>
    Colunas esperadas: <code>date, description, category, amount</code>
  </p>

  <input id="csvInput" type="file" accept=".csv"
         class="mb-4 block mx-auto text-sm file:cursor-pointer file:text-blue-600" />

  <p id="uploadMsg" class="text-sm text-gray-500 mb-6"></p>

  <button id="useDummy" class="text-xs underline text-blue-600 mb-6">
    usar dados-exemplo
  </button><br>

  <button id="toDashBtn" disabled
          class="bg-blue-600 disabled:opacity-40 text-white px-8 py-3 rounded shadow">
    Ver Dashboard
  </button>
</div>
</section>

<!-- ===================== 2) DASHBOARD ================== -->
<section id="dashView" class="hidden flex flex-col min-h-screen">
<header class="bg-white shadow p-4 flex justify-between items-center">
 <h2 class="text-2xl font-bold">Dashboard OrçaAI</h2>

 <div class="flex gap-4 items-center">
   <select id="periodSel" class="border rounded px-3 py-1 text-sm"></select>

   <button id="prevBtn"
           class="bg-amber-500 text-white px-4 py-2 rounded shadow hover:bg-amber-600">
     Previsão
   </button>

   <button id="recBtn"
           class="bg-emerald-600 text-white px-4 py-2 rounded shadow hover:bg-emerald-700">
     Recomendações
   </button>
 </div>
</header>

<main class="p-6 grow flex flex-col items-center">
 <!-- KPIs -->
 <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8 w-full max-w-5xl">
   <div class="bg-white p-4 rounded shadow text-center">
     <p class="text-xs text-gray-500">Total</p><p id="tot" class="text-xl font-bold">R$0,00</p>
   </div>
   <div class="bg-white p-4 rounded shadow text-center">
     <p class="text-xs text-gray-500">Maior despesa</p><p id="big" class="text-xl font-bold">R$0,00</p>
   </div>
   <div class="bg-white p-4 rounded shadow text-center">
     <p class="text-xs text-gray-500">Categoria Top</p><p id="top" class="text-xl font-bold">-</p>
   </div>
 </div>

 <!-- Charts -->
 <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 w-full max-w-5xl">
   <div class="lg:col-span-2 bg-white p-4 rounded shadow">
     <h3 class="font-semibold mb-2">Por categoria</h3>
     <canvas id="pie" height="220"></canvas>
   </div>
   <div class="lg:col-span-3 bg-white p-4 rounded shadow">
     <h3 class="font-semibold mb-2">Histórico mensal</h3>
     <canvas id="line" height="220"></canvas>
   </div>
 </div>

 <!-- Previsão (inicia oculta) -->
 <div id="forecastBox" class="bg-white p-6 rounded shadow w-full max-w-3xl mt-8 hidden">
   <h3 class="font-semibold mb-4 text-center">Previsão – Próximo mês</h3>
   <canvas id="forecastChart" height="200"></canvas>
 </div>
</main>
</section>

<!-- ===================== 3) CHAT & LISTA ================ -->
<div id="chatDrawer"
    class="fixed top-0 right-0 w-full sm:w-96 h-full bg-white shadow-2xl p-4 flex flex-col hidden drawer-enter">
<div class="flex justify-between items-center mb-2">
  <h4 class="font-bold text-lg" id="chatTitle">Recomendações</h4>
  <button id="chatClose" class="text-2xl leading-none text-red-600">&times;</button>
</div>
<div id="chatLog" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
<div class="flex mt-2">
  <input id="chatInp" class="flex-1 border rounded-l px-3 py-2 text-sm" placeholder="Digite...">
  <button id="chatSend" class="bg-blue-600 text-white px-4 rounded-r">Enviar</button>
</div>
</div>

<script>
/* ---------- utilidades básicos ---------- */
const br=v=>v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const MONTHS=['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

let data=[],view=[],pieChart,lineChart,forecastChart;

/* ---------- elementos principais ---------- */
const uploadView=document.getElementById('uploadView'),
     dashView  =document.getElementById('dashView');

const csvInput=document.getElementById('csvInput'),
     uploadMsg=document.getElementById('uploadMsg'),
     toDashBtn=document.getElementById('toDashBtn'),
     useDummy =document.getElementById('useDummy');

const periodSel=document.getElementById('periodSel'),
     totEl=document.getElementById('tot'),
     bigEl=document.getElementById('big'),
     topEl=document.getElementById('top'),
     pieCtx=document.getElementById('pie'),
     lineCtx=document.getElementById('line');

const prevBtn    =document.getElementById('prevBtn'),
     forecastBox=document.getElementById('forecastBox'),
     forecastCtx=document.getElementById('forecastChart');

const recBtn   =document.getElementById('recBtn'),
     drawer   =document.getElementById('chatDrawer'),
     chatTitle=document.getElementById('chatTitle'),
     chatLog  =document.getElementById('chatLog'),
     chatInp  =document.getElementById('chatInp'),
     chatSend =document.getElementById('chatSend'),
     chatClose=document.getElementById('chatClose');

/* ------------ CHAT : funções básicas -------------- */
function addMsg(txt,cls){
 const div=document.createElement('div');
 div.className=`p-2 rounded ${cls==='user'?'bg-blue-600 text-white self-end':'bg-gray-200 self-start'}`;
 div.textContent=txt;
 chatLog.append(div);
 chatLog.scrollTop=chatLog.scrollHeight;
}
function bot(txt){ addMsg(txt,'bot'); }

function openChat(cat,list){
 drawer.classList.remove('hidden');
 chatLog.innerHTML='';
 chatTitle.textContent=cat?`Gastos: ${cat}`:'Recomendações';

 if(cat && list){
    list.forEach(r=>addMsg(`${r.desc} • ${br(r.amt)}`,'bot'));
    bot(`Total em ${cat}: ${br(list.reduce((s,r)=>s+r.amt,0))}`);
 }else{
    bot('Olá! Posso ajudar com recomendações.');
 }
}
chatClose.addEventListener('click',()=>drawer.classList.add('hidden'));
recBtn.addEventListener('click',()=>openChat());

/* ------------- CSV / Dummy ----------------------- */
useDummy.onclick=()=>{
data=[
{date:'2025-01-02',desc:'Supermercado Pão de Açúcar', cat:'Alimentação', amt: 350.70},
{date:'2025-01-03',desc:'Café da Manhã Padaria',    cat:'Alimentação', amt:  18.50},
{date:'2025-01-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 450.00},
{date:'2025-01-06',desc:'Almoço Restaurante Kilo',   cat:'Alimentação', amt:  35.00},
{date:'2025-01-08',desc:'Cinema Shopping',           cat:'Lazer',       amt:  67.00},
{date:'2025-01-09',desc:'Lanche da Tarde',           cat:'Alimentação', amt:  15.00},
{date:'2025-01-10',desc:'Aluguel',                   cat:'Moradia',     amt:1500.00},
{date:'2025-01-12',desc:'Conta de Luz',              cat:'Moradia',     amt: 142.35},
{date:'2025-01-15',desc:'Recarga Celular Pré-pago',  cat:'Outros',      amt:  30.00},
{date:'2025-01-16',desc:'Roupas Loja Renner',        cat:'Vestuário',   amt: 189.90},
{date:'2025-01-18',desc:'Livros Universitários',     cat:'Educação',    amt: 210.40},
{date:'2025-01-20',desc:'Jantar com Amigos',         cat:'Lazer',       amt:  95.00},
{date:'2025-01-22',desc:'Posto Shell',               cat:'Transporte',  amt: 210.00},
{date:'2025-01-24',desc:'Corte de Cabelo',           cat:'Cuidados Pessoais', amt: 80.00},
{date:'2025-01-26',desc:'Assinatura Netflix',        cat:'Outros',      amt:  39.90},
{date:'2025-01-27',desc:'Presente Aniversário Amigo',cat:'Presentes',   amt:  70.00},
{date:'2025-01-29',desc:'Farmácia BemEstar',         cat:'Saúde',       amt:  74.20},
{date:'2025-01-30',desc:'Ifood Pizza',               cat:'Alimentação', amt:  65.00},

{date:'2025-02-01',desc:'Supermercado Central',      cat:'Alimentação', amt: 305.60},
{date:'2025-02-02',desc:'Café Starbucks',            cat:'Alimentação', amt:  25.50},
{date:'2025-02-03',desc:'Restaurante Japonês',       cat:'Alimentação', amt: 120.00},
{date:'2025-02-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 450.00},
{date:'2025-02-05',desc:'Manutenção Bicicleta',      cat:'Transporte',  amt:  75.00}, // Assumindo que a assinatura de bike requer manutenção
{date:'2025-02-06',desc:'Ônibus Mensal',             cat:'Transporte',  amt:  95.00},
{date:'2025-02-07',desc:'IPTU Parcela 1/10',         cat:'Moradia',     amt: 120.00},
{date:'2025-02-08',desc:'Lavanderia',                cat:'Moradia',     amt:  60.00},
{date:'2025-02-09',desc:'Show Arena',                cat:'Lazer',       amt: 250.00},
{date:'2025-02-10',desc:'Aluguel',                   cat:'Moradia',     amt:1500.00},
{date:'2025-02-12',desc:'Almoço Trabalho',           cat:'Alimentação', amt:  38.00},
{date:'2025-02-14',desc:'Internet Fibra',            cat:'Outros',      amt:  99.90},
{date:'2025-02-15',desc:'Produtos de Limpeza Casa',  cat:'Moradia',     amt:  45.30},
{date:'2025-02-17',desc:'Faculdade Mensalidade',     cat:'Educação',    amt: 890.00},
{date:'2025-02-18',desc:'Cinema Ingresso Amigo',     cat:'Lazer',       amt:  35.00},
{date:'2025-02-20',desc:'Posto Shell',               cat:'Transporte',  amt: 185.30},
{date:'2025-02-21',desc:'Sapatos Novos',             cat:'Vestuário',   amt: 220.00},
{date:'2025-02-23',desc:'Spotify Premium',           cat:'Outros',      amt:  19.90},
{date:'2025-02-25',desc:'Consulta Dentista',         cat:'Saúde',       amt: 250.00},
{date:'2025-02-26',desc:'Doação ONG',                cat:'Outros',      amt:  50.00},

{date:'2025-03-01',desc:'Happy Hour com Colegas',    cat:'Lazer',       amt:  78.50},
{date:'2025-03-02',desc:'Supermercado Central',      cat:'Alimentação', amt: 328.75},
{date:'2025-03-04',desc:'Café Gourmet',              cat:'Alimentação', amt:  22.30},
{date:'2025-03-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 450.00},
{date:'2025-03-05',desc:'Uber Aeroporto',            cat:'Transporte',  amt:  55.00},
{date:'2025-03-07',desc:'IPTU Parcela 2/10',         cat:'Moradia',     amt: 120.00},
{date:'2025-03-08',desc:'Parque de Diversões',       cat:'Lazer',       amt: 132.00},
{date:'2025-03-10',desc:'Aluguel',                   cat:'Moradia',     amt:1500.00},
{date:'2025-03-11',desc:'Almoço Self-Service',       cat:'Alimentação', amt:  32.00},
{date:'2025-03-12',desc:'Conta de Água',             cat:'Moradia',     amt:  88.40},
{date:'2025-03-14',desc:'Cosméticos Farmácia',       cat:'Cuidados Pessoais', amt: 95.50},
{date:'2025-03-15',desc:'Curso Online Python',       cat:'Educação',    amt: 149.00},
{date:'2025-03-19',desc:'Posto Ipiranga',            cat:'Transporte',  amt: 197.85},
{date:'2025-03-21',desc:'Presente Casamento',        cat:'Presentes',   amt: 150.00},
{date:'2025-03-24',desc:'Assinatura Disney+',        cat:'Outros',      amt:  33.90},
{date:'2025-03-26',desc:'Delivery Jantar (App)',     cat:'Alimentação', amt:  58.90},
{date:'2025-03-28',desc:'Exames Laboratório',        cat:'Saúde',       amt: 280.00},

{date:'2025-04-01',desc:'Supermercado Central',      cat:'Alimentação', amt: 315.10},
{date:'2025-04-02',desc:'Café com Bolo',             cat:'Alimentação', amt:  20.00},
{date:'2025-04-03',desc:'Padaria Sonhos',            cat:'Alimentação', amt:  28.90},
{date:'2025-04-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 455.00}, // Pequeno aumento
{date:'2025-04-05',desc:'Passagem Ônibus',           cat:'Transporte',  amt:   8.50},
{date:'2025-04-07',desc:'IPTU Parcela 3/10',         cat:'Moradia',     amt: 120.00},
{date:'2025-04-07',desc:'Teatro Municipal',          cat:'Lazer',       amt:  95.00},
{date:'2025-04-10',desc:'Aluguel',                   cat:'Moradia',     amt:1500.00},
{date:'2025-04-11',desc:'Almoço Executivo',          cat:'Alimentação', amt:  45.00},
{date:'2025-04-13',desc:'Conta de Luz',              cat:'Moradia',     amt: 156.90},
{date:'2025-04-15',desc:'Reparo Pequeno em Casa',    cat:'Moradia',     amt:  80.00},
{date:'2025-04-16',desc:'Workshop Marketing',        cat:'Educação',    amt: 320.00},
{date:'2025-04-18',desc:'Camiseta Nova',             cat:'Vestuário',   amt:  89.90},
{date:'2025-04-20',desc:'Posto BR',                  cat:'Transporte',  amt: 210.75},
{date:'2025-04-23',desc:'Apple Music',               cat:'Outros',      amt:  21.90},
{date:'2025-04-25',desc:'Bar com Amigos',            cat:'Lazer',       amt: 110.00},
{date:'2025-04-27',desc:'Vacina Gripe',              cat:'Saúde',       amt:  60.00},
{date:'2025-04-29',desc:'Lanche Viagem',             cat:'Alimentação', amt:  25.00},

{date:'2025-05-01',desc:'Presente Dia das Mães',     cat:'Presentes',   amt: 120.00},
{date:'2025-05-02',desc:'Supermercado Central',      cat:'Alimentação', amt: 347.20},
{date:'2025-05-03',desc:'Café Especial',             cat:'Alimentação', amt:  28.00},
{date:'2025-05-04',desc:'Restaurante Italiano',      cat:'Alimentação', amt: 185.00},
{date:'2025-05-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 455.00},
{date:'2025-05-06',desc:'Assinatura Bike',           cat:'Transporte',  amt:  29.90},
{date:'2025-05-07',desc:'IPTU Parcela 4/10',         cat:'Moradia',     amt: 120.00},
{date:'2025-05-08',desc:'Concerto Orquestra',        cat:'Lazer',       amt: 180.00},
{date:'2025-05-10',desc:'Aluguel',                   cat:'Moradia',     amt:1500.00},
{date:'2025-05-12',desc:'Almoço Marmita',            cat:'Alimentação', amt:  28.00},
{date:'2025-05-14',desc:'Seguro Residencial',        cat:'Moradia',     amt:  79.99},
{date:'2025-05-16',desc:'Manicure',                  cat:'Cuidados Pessoais', amt: 50.00},
{date:'2025-05-17',desc:'Curso Fotografia',          cat:'Educação',    amt: 250.00},
{date:'2025-05-19',desc:'Posto Shell',               cat:'Transporte',  amt: 198.60},
{date:'2025-05-21',desc:'Livro Ficção',              cat:'Lazer',       amt:  45.00},
{date:'2025-05-22',desc:'Google Drive',              cat:'Outros',      amt:   9.99},
{date:'2025-05-25',desc:'Consulta Psicólogo',        cat:'Saúde',       amt: 220.00},
{date:'2025-05-28',desc:'Jantar Delivery Sushi',     cat:'Alimentação', amt:  85.00},

{date:'2025-06-01',desc:'Ingresso Museu',            cat:'Lazer',       amt:  40.00},
{date:'2025-06-02',desc:'Supermercado Central',      cat:'Alimentação', amt: 299.45},
{date:'2025-06-03',desc:'Cafeteria Centro',          cat:'Alimentação', amt:  19.80},
{date:'2025-06-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 455.00},
{date:'2025-06-05',desc:'Uber Trabalho',             cat:'Transporte',  amt:  40.75},
{date:'2025-06-07',desc:'IPTU Parcela 5/10',         cat:'Moradia',     amt: 120.00},
{date:'2025-06-08',desc:'Netflix Cinema',            cat:'Lazer',       amt:  62.00}, // Assumindo que é um evento especial Netflix
{date:'2025-06-10',desc:'Aluguel',                   cat:'Moradia',     amt:1500.00},
{date:'2025-06-11',desc:'Almoço Padaria',            cat:'Alimentação', amt:  25.00},
{date:'2025-06-12',desc:'Conta de Água',             cat:'Moradia',     amt:  91.70},
{date:'2025-06-13',desc:'Presente Namorado(a)',      cat:'Presentes',   amt: 180.00}, // Dia dos Namorados
{date:'2025-06-15',desc:'Faculdade Mensalidade',     cat:'Educação',    amt: 890.00},
{date:'2025-06-17',desc:'Calça Jeans',               cat:'Vestuário',   amt: 159.90},
{date:'2025-06-18',desc:'Posto Ipiranga',            cat:'Transporte',  amt: 205.10},
{date:'2025-06-21',desc:'Assinatura Amazon',         cat:'Outros',      amt:  14.90},
{date:'2025-06-23',desc:'Rodízio Pizza Amigos',      cat:'Alimentação', amt:  70.00},
{date:'2025-06-25',desc:'Medicamentos',              cat:'Saúde',       amt:  95.00},
{date:'2025-06-28',desc:'Produtos Petshop',          cat:'Outros',      amt:  85.00}, // Se tiver pet

{date:'2025-07-01',desc:'Supermercado Central',      cat:'Alimentação', amt: 322.60},
{date:'2025-07-02',desc:'Café e Pão de Queijo',      cat:'Alimentação', amt:  16.00},
{date:'2025-07-03',desc:'Padaria Doce Pão',          cat:'Alimentação', amt:  24.70},
{date:'2025-07-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 460.00}, // Reajuste
{date:'2025-07-05',desc:'Metrô Mensal',              cat:'Transporte',  amt: 110.00},
{date:'2025-07-07',desc:'IPTU Parcela 6/10',         cat:'Moradia',     amt: 125.00}, // Reajuste IPTU
{date:'2025-07-08',desc:'Show Rock',                 cat:'Lazer',       amt: 260.00},
{date:'2025-07-10',desc:'Aluguel',                   cat:'Moradia',     amt:1550.00}, // Reajuste Aluguel
{date:'2025-07-11',desc:'Almoço Buffet Livre',       cat:'Alimentação', amt:  42.00},
{date:'2025-07-12',desc:'Conta de Luz',              cat:'Moradia',     amt: 162.40},
{date:'2025-07-15',desc:'Serviço de Streaming Música',cat:'Outros',     amt:  25.00},
{date:'2025-07-16',desc:'Curso Design',              cat:'Educação',    amt: 340.00},
{date:'2025-07-18',desc:'Hidratante Corporal',       cat:'Cuidados Pessoais', amt: 65.00},
{date:'2025-07-19',desc:'Posto BR',                  cat:'Transporte',  amt: 215.90},
{date:'2025-07-22',desc:'Microsoft 365',             cat:'Outros',      amt:  36.00},
{date:'2025-07-24',desc:'Festa Julina (Comidas)',    cat:'Alimentação', amt:  55.00},
{date:'2025-07-26',desc:'Exame Vista',               cat:'Saúde',       amt: 180.00},
{date:'2025-07-29',desc:'Acessório Celular',         cat:'Outros',      amt:  49.90},

{date:'2025-08-01',desc:'Passeio no Parque (lanche)',cat:'Lazer',       amt:  30.00},
{date:'2025-08-02',desc:'Supermercado Central',      cat:'Alimentação', amt: 338.10},
{date:'2025-08-03',desc:'Restaurante Mexicano',      cat:'Alimentação', amt: 142.00},
{date:'2025-08-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 460.00},
{date:'2025-08-05',desc:'Ônibus Interurbano',        cat:'Transporte',  amt:  48.50},
{date:'2025-08-07',desc:'IPTU Parcela 7/10',         cat:'Moradia',     amt: 125.00},
{date:'2025-08-07',desc:'Cinema 3D',                 cat:'Lazer',       amt:  78.00},
{date:'2025-08-09',desc:'Presente Dia dos Pais',     cat:'Presentes',   amt: 130.00},
{date:'2025-08-10',desc:'Aluguel',                   cat:'Moradia',     amt:1550.00},
{date:'2025-08-11',desc:'Café da Tarde Reunião',     cat:'Alimentação', amt:  22.00},
{date:'2025-08-13',desc:'Internet Fibra',            cat:'Outros',      amt: 109.90}, // Aumento
{date:'2025-08-15',desc:'Tênis Corrida',             cat:'Vestuário',   amt: 299.00},
{date:'2025-08-16',desc:'Curso Inglês',              cat:'Educação',    amt: 290.00},
{date:'2025-08-19',desc:'Posto Shell',               cat:'Transporte',  amt: 208.30},
{date:'2025-08-21',desc:'Jogo de Tabuleiro',         cat:'Lazer',       amt: 120.00},
{date:'2025-08-23',desc:'Spotify Premium',           cat:'Outros',      amt:  19.90},
{date:'2025-08-26',desc:'Clínica Odonto',            cat:'Saúde',       amt: 260.00},
{date:'2025-08-28',desc:'Happy Hour Barzinho',       cat:'Alimentação', amt:  88.00},

{date:'2025-09-01',desc:'Supermercado Central',      cat:'Alimentação', amt: 345.75},
{date:'2025-09-02',desc:'Café Express',              cat:'Alimentação', amt:  18.00},
{date:'2025-09-04',desc:'Uber Aeroporto',            cat:'Transporte',  amt:  75.00},
{date:'2025-09-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 460.00},
{date:'2025-09-07',desc:'IPTU Parcela 8/10',         cat:'Moradia',     amt: 125.00},
{date:'2025-09-07',desc:'Parque Aquático',           cat:'Lazer',       amt: 150.00},
{date:'2025-09-10',desc:'Aluguel',                   cat:'Moradia',     amt:1550.00},
{date:'2025-09-12',desc:'Conta de Água',             cat:'Moradia',     amt:  97.50},
{date:'2025-09-13',desc:'Almoço com a Família',      cat:'Alimentação', amt: 160.00},
{date:'2025-09-15',desc:'Workshop Data',             cat:'Educação',    amt: 410.00},
{date:'2025-09-17',desc:'Barbearia',                 cat:'Cuidados Pessoais', amt: 60.00},
{date:'2025-09-18',desc:'Posto Ipiranga',            cat:'Transporte',  amt: 212.00},
{date:'2025-09-20',desc:'Ingresso Show Stand Up',    cat:'Lazer',       amt:  80.00},
{date:'2025-09-22',desc:'Apple TV',                  cat:'Outros',      amt:  19.90},
{date:'2025-09-25',desc:'ClinLab Exames',            cat:'Saúde',       amt: 300.00},
{date:'2025-09-28',desc:'Feira de Artesanato (compras)',cat:'Outros',   amt:  65.00},

{date:'2025-10-01',desc:'Café e Croissant',          cat:'Alimentação', amt:  23.50},
{date:'2025-10-02',desc:'Supermercado Central',      cat:'Alimentação', amt: 330.90},
{date:'2025-10-03',desc:'Restaurante Vegano',        cat:'Alimentação', amt: 135.00},
{date:'2025-10-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 460.00},
{date:'2025-10-06',desc:'Bilhete Único Recarga',     cat:'Transporte',  amt:  60.00}, // Recarga avulsa
{date:'2025-10-07',desc:'IPTU Parcela 9/10',         cat:'Moradia',     amt: 125.00},
{date:'2025-10-08',desc:'Show Jazz',                 cat:'Lazer',       amt: 190.00},
{date:'2025-10-10',desc:'Aluguel',                   cat:'Moradia',     amt:1550.00},
{date:'2025-10-12',desc:'Presente Dia Crianças (sobrinho)',cat:'Presentes', amt: 90.00},
{date:'2025-10-14',desc:'Seguro Casa',               cat:'Moradia',     amt:  82.99},
{date:'2025-10-16',desc:'Almoço Reunião Cliente',    cat:'Alimentação', amt:  55.00},
{date:'2025-10-17',desc:'Curso Java',                cat:'Educação',    amt: 370.00},
{date:'2025-10-19',desc:'Jaqueta Nova',              cat:'Vestuário',   amt: 250.00},
{date:'2025-10-20',desc:'Posto BR',                  cat:'Transporte',  amt: 220.50},
{date:'2025-10-23',desc:'Google One',                cat:'Outros',      amt:  12.99},
{date:'2025-10-25',desc:'Escape Room com Amigos',    cat:'Lazer',       amt:  75.00},
{date:'2025-10-27',desc:'Vacina Viagem',             cat:'Saúde',       amt: 180.00},
{date:'2025-10-30',desc:'Doces Finos Confeitaria',   cat:'Alimentação', amt:  40.00},

{date:'2025-11-01',desc:'Supermercado Central',      cat:'Alimentação', amt: 360.40},
{date:'2025-11-03',desc:'Cafeteria Centro',          cat:'Alimentação', amt:  21.30},
{date:'2025-11-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 460.00},
{date:'2025-11-05',desc:'Uber Trabalho',             cat:'Transporte',  amt:  42.60},
{date:'2025-11-07',desc:'IPTU Parcela 10/10 (Última)',cat:'Moradia',    amt: 125.00},
{date:'2025-11-08',desc:'Teatro Musical',            cat:'Lazer',       amt: 210.00},
{date:'2025-11-10',desc:'Aluguel',                   cat:'Moradia',     amt:1550.00},
{date:'2025-11-12',desc:'Conta de Luz',              cat:'Moradia',     amt: 170.25},
{date:'2025-11-13',desc:'Almoço com Colegas',        cat:'Alimentação', amt:  39.00},
{date:'2025-11-15',desc:'Palestra UX',               cat:'Educação',    amt: 260.00},
{date:'2025-11-17',desc:'Perfumaria',                cat:'Cuidados Pessoais', amt: 150.00},
{date:'2025-11-18',desc:'Posto Shell',               cat:'Transporte',  amt: 225.80},
{date:'2025-11-20',desc:'Compra Jogos Online',       cat:'Lazer',       amt:  99.00},
{date:'2025-11-22',desc:'Disney+',                   cat:'Outros',      amt:  33.90},
{date:'2025-11-25',desc:'Consulta Gastro',           cat:'Saúde',       amt: 310.00},
{date:'2025-11-28',desc:'Black Friday - Eletrônico', cat:'Outros',      amt: 450.00}, // Compra maior
{date:'2025-11-29',desc:'Jantar Especial Fim de Mês',cat:'Alimentação', amt: 190.00},

{date:'2025-12-01',desc:'Decoração de Natal',        cat:'Moradia',     amt:  80.00},
{date:'2025-12-02',desc:'Supermercado Central',      cat:'Alimentação', amt: 375.20}, // Compras de fim de ano
{date:'2025-12-03',desc:'Restaurante Francês',       cat:'Alimentação', amt: 220.00},
{date:'2025-12-05',desc:'Condomínio Edifício Sol',   cat:'Moradia',     amt: 465.00}, // Ajuste anual condomínio
{date:'2025-12-06',desc:'Metrô Mensal',              cat:'Transporte',  amt: 115.00},
{date:'2025-12-08',desc:'Cinema IMAX',               cat:'Lazer',       amt:  88.00},
{date:'2025-12-10',desc:'Aluguel',                   cat:'Moradia',     amt:1550.00},
{date:'2025-12-11',desc:'Amigo Secreto (Presente)',  cat:'Presentes',   amt: 100.00},
{date:'2025-12-13',desc:'Ceia de Natal (contribuição)',cat:'Alimentação',amt: 150.00},
{date:'2025-12-14',desc:'Internet Fibra',            cat:'Outros',      amt: 109.90},
{date:'2025-12-16',desc:'Roupas Festa Fim de Ano',   cat:'Vestuário',   amt: 320.00},
{date:'2025-12-17',desc:'Curso React',               cat:'Educação',    amt: 390.00},
{date:'2025-12-19',desc:'Posto Ipiranga',            cat:'Transporte',  amt: 230.40}, // Mais viagens fim de ano
{date:'2025-12-20',desc:'Presentes de Natal Família',cat:'Presentes',   amt: 500.00},
{date:'2025-12-23',desc:'Spotify Premium',           cat:'Outros',      amt:  19.90},
{date:'2025-12-27',desc:'Check-up Anual',            cat:'Saúde',       amt: 600.00},
{date:'2025-12-29',desc:'Viagem Fim de Ano (parte)', cat:'Lazer',       amt: 700.00}, // Gasto maior de viagem
{date:'2025-12-30',desc:'Compras Supermercado Réveillon',cat:'Alimentação',amt:250.00}];                       // coloquei vazio só p/ teste
uploadMsg.textContent='Dados de demonstração carregados.';
toDashBtn.disabled=false;
};

/* ... PARSE CSV (mesmo código que já tinha) ... */
csvInput.onchange=e=>{
const f=e.target.files[0];if(!f){toDashBtn.disabled=true;return;}
Papa.parse(f,{header:true,skipEmptyLines:true,delimiter:'auto',trimHeaders:true,
 transformHeader:h=>h.trim(),transform:v=>v.trim(),
 complete:({data:rows})=>{
   const pick=(o,...k)=>k.map(x=>o[x]).find(v=>v!==undefined);
   data=rows.map(r=>{
     const raw=(pick(r,'amount','Amount','valor','Valor')||'').replace(/\./g,'').replace(',','.');
     return{date:(pick(r,'date','Date','data','Data')||'').split(' ')[0],
            desc:pick(r,'description','Description','descricao','Descrição')||'',
            cat: pick(r,'category','Category','categoria','Categoria')||'',
            amt: parseFloat(raw)};
   }).filter(r=>r.date&&r.cat&&!isNaN(r.amt));
   if(!data.length){uploadMsg.textContent='Nenhuma linha válida.';toDashBtn.disabled=true;}
   else{uploadMsg.textContent=`${data.length} lançamentos carregados.`;toDashBtn.disabled=false;}
 },
 error:()=>{uploadMsg.textContent='Erro ao ler CSV.';toDashBtn.disabled=true;}
});
};

/* ---------- entrar no dashboard -------------- */
toDashBtn.onclick=()=>{
uploadView.classList.add('hidden');
dashView.classList.remove('hidden');
fillSelect(); refreshDash();
};

/* ---------- select períodos ------------------ */
function fillSelect(){
periodSel.innerHTML='';
periodSel.add(new Option('Todos','all'));
periodSel.add(new Option('Últimos 3 meses','last3'));
[...new Set(data.map(r=>r.date.slice(0,7)))].sort()
  .forEach(m=>{const [y,mo]=m.split('-');
               periodSel.add(new Option(`${MONTHS[+mo-1]}/${y}`,m));});
periodSel.value='all';
}
periodSel.onchange=refreshDash;

/* ---------- refresh KPI + charts ------------- */
function refreshDash(){
forecastBox.classList.add('hidden');
const v=periodSel.value;
view=(v==='all')?data:
     (v==='last3')?data.filter(r=>new Date(r.date)>=new Date(new Date().setMonth(new Date().getMonth()-2))):
                   data.filter(r=>r.date.startsWith(v));

if(!view.length){
  totEl.textContent=bigEl.textContent='R$0,00';topEl.textContent='-';
  drawPie({});drawLine();return;
}
const total=view.reduce((s,r)=>s+r.amt,0);
const maior=Math.max(...view.map(r=>r.amt));
const catSum={};view.forEach(r=>catSum[r.cat]=(catSum[r.cat]||0)+r.amt);
const topCat=Object.entries(catSum).sort((a,b)=>b[1]-a[1])[0][0];
totEl.textContent=br(total);bigEl.textContent=br(maior);topEl.textContent=topCat;
drawPie(catSum);drawLine();
}

/* ---------- Pie chart ------------------------- */
function drawPie(catSum){
if(pieChart)pieChart.destroy();
const labels=Object.keys(catSum),vals=Object.values(catSum),
      colors=['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#06b6d4','#a855f7','#f97316'];
pieChart=new Chart(pieCtx,{type:'doughnut',
  data:{labels,datasets:[{data:vals,backgroundColor:colors.slice(0,labels.length)}]},
  options:{plugins:{legend:{position:'bottom'}},
           onClick:(e,els)=>{if(!els.length)return;
                const cat=labels[els[0].index];
                const lst=view.filter(r=>r.cat===cat).sort((a,b)=>b.amt-a.amt);
                openChat(cat,lst);}}
});
}

/* ---------- Line chart + previsão total ------- */
function drawLine(){
if(lineChart)lineChart.destroy();
const sel=periodSel.value,now=new Date();let histLabels=[];
if(sel==='all'){const y=data[0]?.date.slice(0,4)||now.getFullYear();
                histLabels=Array.from({length:12},(_,i)=>`${y}-${String(i+1).padStart(2,'0')}`);}
else if(sel==='last3'){for(let i=2;i>=0;i--){const d=new Date(now.getFullYear(),now.getMonth()-i,1);
                  histLabels.push(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`);}}
else histLabels=[sel];

const histVals=histLabels.map(m=>view.filter(r=>r.date.startsWith(m))
                                     .reduce((s,r)=>s+r.amt,0));
const next=getNextMonthObject();
const forecastTotal=Object.values(calcForecastPerCategory(data,next.refYm)).reduce((s,v)=>s+v,0);

const labs=[...histLabels.map(m=>`${MONTHS[+m.slice(5)-1]}/${m.slice(0,4)}`),next.label];
const histData=[...histVals,null];
const projData=[...Array(histVals.length).fill(null),forecastTotal];

lineChart=new Chart(lineCtx,{type:'line',
  data:{labels:labs,
    datasets:[
      {label:'Histórico',data:histData,borderColor:'#3b82f6',
       backgroundColor:'rgba(59,130,246,.15)',fill:true,tension:.3},
      {label:'Projeção total (próx. mês)',data:projData,borderColor:'#10b981',
       borderDash:[6,4],pointStyle:'rect',fill:false,tension:.3}
    ]},
  options:{plugins:{legend:{position:'top'}},
           scales:{y:{ticks:{callback:v=>'R$'+v.toLocaleString('pt-BR')}}}}
});
}

/* ---------- painel previsão detalhada --------- */
prevBtn.onclick=()=>{
 if(forecastBox.classList.contains('hidden')){drawForecast();forecastBox.classList.remove('hidden');
     prevBtn.classList.add('ring','ring-amber-300');}
 else{forecastBox.classList.add('hidden');prevBtn.classList.remove('ring','ring-amber-300');}
};
function drawForecast(){
if(forecastChart)forecastChart.destroy();
const next=getNextMonthObject();
const byCat=calcForecastPerCategory(data,next.refYm);
forecastChart=new Chart(forecastCtx,{type:'bar',
  data:{labels:Object.keys(byCat),
        datasets:[{label:`Previsto para ${next.label}`,data:Object.values(byCat),
                   backgroundColor:'#f59e0b'}]},
  options:{plugins:{legend:{display:false}},
           scales:{y:{beginAtZero:true,ticks:{callback:v=>'R$'+v.toLocaleString('pt-BR')}}}}
});
}

/* ---------- getNextMonthObject ---------------- */
function getNextMonthObject(){
const last=new Date(Math.max(...data.map(r=>new Date(r.date))));
const nm=new Date(last.getFullYear(),last.getMonth()+1,1);
const ref=`${nm.getFullYear()}-${String(nm.getMonth()+1).padStart(2,'0')}`;
return{refYm:ref,label:`${MONTHS[nm.getMonth()]}/${nm.getFullYear()}`};
}

/* ---------- calcForecastPerCategory ----------- */
function calcForecastPerCategory(all,ref){
const map={};all.forEach(r=>{
  const ym=r.date.slice(0,7);
  (map[r.cat]=map[r.cat]||{})[ym]=(map[r.cat][ym]||0)+r.amt;
});
const out={};
Object.keys(map).forEach(cat=>{
  const months=Object.keys(map[cat]).sort();
  const last3=months.slice(-3).map(m=>map[cat][m]);
  const lastVal=last3[last3.length-1];
  const isFix=/aluguel|condom|iptu|mensalidade|assinatura|seguro/i.test(cat);
  if(isFix) out[cat]=lastVal??0;
  else if(/supermercado/i.test(cat)){
    const w=[3,2,1].slice(-last3.length);
    out[cat]=parseFloat((last3.reduce((s,v,i)=>s+v*w[i],0)/w.reduce((a,b)=>a+b)).toFixed(2));
  }else{
    out[cat]=parseFloat((last3.reduce((s,v)=>s+v,0)/last3.length).toFixed(2));
  }
});
return out;
}

/* ---------- Chat comandos simples ------------- */
chatSend.onclick = ()=>{
const q = chatInp.value.trim();
if(!q) return;
addMsg(q,'user');
chatInp.value = '';

const txt = q.toLowerCase();
if(/insight/.test(txt)){ bot(makeInsight(txt)); return; }
if(/economizar|cortar/.test(txt)){ bot(makeSavingsPlan(txt)); return; }
if(/previs(ão|ao)/.test(txt)){ bot(makeTotalForecast()); return; }

bot('Ainda não entendi. Tente “Insight geral”, “Economizar 500” ou “Previsão”.');
};

/* ========== helpers de insight / economia ========== */
function lastMonths(n, predicate){
const ymList = [...new Set(data.map(r=>r.date.slice(0,7)))].sort().slice(-n);
return ymList.reduce((sum,ym)=>{
    return sum + data
      .filter(r=>r.date.startsWith(ym) && (!predicate || predicate(r)))
      .reduce((s,r)=>s+r.amt,0);
},0) / n;
}

function makeInsight(cmd){
/* --- insight de assinaturas (procura na descrição) --- */
if(/assinatura/.test(cmd)){
     const cur  = lastMonths(1 , r=>/assinatura/i.test(r.desc));
     const prev = lastMonths(6 , r=>/assinatura/i.test(r.desc));
     const diff = prev ? ((cur-prev)/prev*100).toFixed(1) : '-';
     return `Assinaturas estão em ${br(cur)} (${diff === '-' ? 'sem base de comparação' : diff+'% vs. média 6 m'}).`;
}

/* --- insight de conta de luz ------------------------- */
if(/luz|energia/.test(cmd)){
     const cur  = lastMonths(1 , r=>/luz|energia/i.test(r.desc));
     const prev = lastMonths(3 , r=>/luz|energia/i.test(r.desc));
     const diff = prev ? ((cur-prev)/prev*100).toFixed(1) : '-';
     return `Conta de luz: ${br(cur)} (${diff==='-'?'sem base': diff+'% vs. média 3 m'}).`;
}

/* --- insight genérico ------------------------------- */
const cur  = lastMonths(1);
const prev = lastMonths(2);
const pct  = prev ? ((cur-prev)/prev*100).toFixed(1)+'%' : '-';
return `Total do mês: ${br(cur)} (${pct} vs. média 2 m).`;
}
function makeSavingsPlan(txt){
const val=txt.match(/(\d{2,})/);const pct=txt.match(/(\d{1,2})\s*%/);
let alvo=0;
if(val) alvo=parseFloat(val[1]);
else if(pct){const perc=parseFloat(pct[1])/100;
  const variav=data.filter(r=>/lazer|delivery|restaurante|vestuário|café/i.test(r.cat));
  alvo=variav.reduce((s,r)=>s+r.amt,0)*perc;
}else return 'Informe um valor ou %: “Economizar 500” ou “Cortar 15%”.';
const cats=['Lazer','Delivery','Restaurantes','Vestuário','Cafés & Lanches'];
let sobra=alvo,plano=[];
cats.forEach(c=>{
  const g=lastMonths(1,new RegExp(c,'i'));
  if(sobra>0&&g>0){
    const cut=Math.min(g*0.4,sobra);
    plano.push(`${c} -R$ ${cut.toFixed(0)}`);sobra-=cut;
  }
});
return `Para economizar R$ ${alvo.toFixed(0)} sugiro: ${plano.join(', ')}.`;
}
function makeTotalForecast(){
const next=getNextMonthObject();
const total=Object.values(calcForecastPerCategory(data,next.refYm)).reduce((s,v)=>s+v,0);
return `Previsão total para ${next.label}: R$ ${total.toFixed(2)}.`;
}

/* --------- auto-load dummy                */
useDummy.click();
</script>
</body>
</html>